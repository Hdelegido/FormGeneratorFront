<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormGenerator TFG - Metodologia Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <style>
        /* üåü VARIABLES CSS WCAG AAA COMPLIANT */
        :root {
            /* COLORES PRINCIPALES - Contraste 7:1 m√≠nimo para AAA */
            --primary-dark: #0f172a; /* Para texto en fondo claro - Contraste 15.1:1 */
            --primary-blue: #1e40af; /* Azul profesional - Contraste 8.6:1 */
            --primary-purple: #6b21a8; /* P√∫rpura corporativo - Contraste 9.1:1 */
            --accent-teal: #0f766e; /* Verde teal - Contraste 8.2:1 */

            /* COLORES DE ESTADO - Alta visibilidad */
            --success-dark: #15803d; /* Verde √©xito - Contraste 7.8:1 */
            --danger-dark: #b91c1c; /* Rojo error - Contraste 9.2:1 */
            --warning-dark: #a16207; /* Amarillo advertencia - Contraste 8.1:1 */
            --info-dark: #1e40af; /* Azul informaci√≥n - Contraste 8.6:1 */

            /* ESCALA DE GRISES PROFESIONAL */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;

            /* FONDOS Y CONTENEDORES */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --surface-elevated: #ffffff;
            --surface-overlay: rgba(15, 23, 42, 0.95);

            /* TEXTO Y CONTRASTE */
            --text-primary: #0f172a; /* M√°ximo contraste */
            --text-secondary: #1e293b; /* Alto contraste */
            --text-muted: #475569; /* Contraste moderado pero AAA */
            --text-inverse: #ffffff;

            /* BORDES Y SEPARADORES */
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            --border-strong: #94a3b8;

            /* DIMENSIONES Y ESPACIADO */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;

            /* SOMBRAS PROFESIONALES */
            --shadow-xs: 0 1px 2px 0 rgba(15, 23, 42, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(15, 23, 42, 0.1), 0 1px 2px -1px rgba(15, 23, 42, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(15, 23, 42, 0.1), 0 2px 4px -2px rgba(15, 23, 42, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.1), 0 4px 6px -4px rgba(15, 23, 42, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(15, 23, 42, 0.1), 0 8px 10px -6px rgba(15, 23, 42, 0.1);

            /* TRANSICIONES SUAVES */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);

            /* TIPOGRAF√çA PROFESIONAL */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Consolas, monospace;

            /* PESOS DE FUENTE */
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            /* L√çNEAS DE ALTURA */
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.625;
        }

        /* üåô TEMA OSCURO - TAMBI√âN WCAG AAA COMPLIANT */
        [data-theme="dark"] {
            --primary-blue: #3b82f6; /* Azul m√°s claro para fondo oscuro */
            --primary-purple: #a855f7; /* P√∫rpura m√°s visible */
            --accent-teal: #14b8a6; /* Teal m√°s brillante */

            --success-dark: #22c55e;
            --danger-dark: #ef4444;
            --warning-dark: #f59e0b;
            --info-dark: #3b82f6;

            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --surface-elevated: #1e293b;
            --surface-overlay: rgba(248, 250, 252, 0.95);

            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-inverse: #0f172a;

            --border-light: #334155;
            --border-medium: #475569;
            --border-strong: #64748b;
        }

        /* üéØ RESET Y BASE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        body {
            font-family: var(--font-sans);
            font-size: 16px;
            line-height: var(--leading-normal);
            color: var(--text-primary);
            background-color: var(--bg-secondary);
            transition: background-color var(--transition-base), color var(--transition-base);
            overflow-x: hidden;
        }

        /* üì± CONTENEDOR RESPONSIVO */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* üéØ HEADER PROFESIONAL */
        .header {
            background: linear-gradient(135deg, var(--surface-elevated) 0%, var(--bg-tertiary) 100%);
            border-bottom: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(8px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--text-primary);
        }

        .header-logo:hover {
            opacity: 0.8;
            transition: opacity var(--transition-fast);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .header-title {
            font-size: 1.875rem;
            font-weight: var(--font-bold);
            color: var(--text-primary);
            line-height: var(--leading-tight);
        }

        .header-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: var(--font-medium);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .version-badge {
            background-color: var(--accent-teal);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-medium);
            background-color: var(--surface-elevated);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-blue);
        }

        /* üé¥ CARDS PROFESIONALES */
        .card {
            background-color: var(--surface-elevated);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            padding: 2rem;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple), var(--accent-teal));
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-medium);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            line-height: var(--leading-tight);
        }

        /* üìä GRID SYSTEM */
        .grid {
            display: grid;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .grid-cols-1 {
            grid-template-columns: 1fr;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 1024px) {
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .grid-cols-2,
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }

        /* üìù FORMULARIOS AVANZADOS */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            line-height: var(--leading-tight);
        }

        .form-label-required::after {
            content: ' *';
            color: var(--danger-dark);
            font-weight: var(--font-bold);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            line-height: var(--leading-normal);
            color: var(--text-primary);
            background-color: var(--surface-elevated);
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            font-family: var(--font-sans);
        }

        .form-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background-color: var(--bg-primary);
        }

        .form-control:hover:not(:focus) {
            border-color: var(--border-strong);
        }

        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        /* Selects mejorados */
        select.form-control {
            cursor: pointer;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23475569' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        /* Estados de error */
        .form-control.error {
            border-color: var(--danger-dark);
            background-color: rgba(185, 28, 28, 0.05);
        }

        .form-error {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--danger-dark);
            font-weight: var(--font-medium);
        }

        /* üéØ BOTONES PROFESIONALES */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            line-height: var(--leading-tight);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            font-family: var(--font-sans);
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Variantes de botones */
        .btn-primary {
            background-color: var(--primary-blue);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--primary-purple);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            background-color: #7c2d92;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background-color: var(--success-dark);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover {
            background-color: #166534;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background-color: var(--danger-dark);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-danger:hover {
            background-color: #991b1b;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-blue);
            border-color: var(--border-medium);
        }

        .btn-outline:hover {
            background-color: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 1rem;
        }

        .btn-ghost:hover {
            background-color: var(--bg-tertiary);
        }

        /* Tama√±os de botones */
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        /* üè∑Ô∏è TABS MODERNAS */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-light);
            overflow-x: auto;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: var(--font-medium);
            color: var(--text-muted);
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            font-family: var(--font-sans);
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }

        .tab-btn.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background-color: rgba(59, 130, 246, 0.05);
        }

        .tab-btn i {
            margin-right: 0.5rem;
        }

        /* üìã LISTAS Y ITEMS */
        .list-container {
            background-color: var(--surface-elevated);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            overflow: hidden;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            transition: background-color var(--transition-fast);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background-color: var(--bg-tertiary);
        }

        .list-content {
            flex: 1;
            min-width: 0;
        }

        .list-title {
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .list-description {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: var(--leading-normal);
        }

        .list-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        /* üé® BADGES Y ESTADOS */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: var(--font-semibold);
            border-radius: var(--radius-md);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-primary {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-blue);
        }

        .badge-success {
            background-color: rgba(21, 128, 61, 0.1);
            color: var(--success-dark);
        }

        .badge-danger {
            background-color: rgba(185, 28, 28, 0.1);
            color: var(--danger-dark);
        }

        .badge-warning {
            background-color: rgba(161, 98, 7, 0.1);
            color: var(--warning-dark);
        }

        /* üîç SEARCH Y FILTROS */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            padding-left: 2.75rem;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23475569'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E");
            background-position: 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25rem;
        }

        /* üéØ LOADING STATES */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* üö® EMPTY STATES */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: var(--font-semibold);
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state-description {
            font-size: 0.875rem;
            line-height: var(--leading-relaxed);
        }

        /* üîî TOASTS Y NOTIFICACIONES */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            max-width: 400px;
            background-color: var(--surface-elevated);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            z-index: 100;
            animation: slideInToast 0.3s ease-out;
        }

        .toast-icon {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
            margin-top: 0.125rem;
        }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-muted);
            line-height: var(--leading-normal);
        }

        .toast-close {
            flex-shrink: 0;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .toast.success {
            border-left: 4px solid var(--success-dark);
        }

        .toast.error {
            border-left: 4px solid var(--danger-dark);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-dark);
        }

        .toast.info {
            border-left: 4px solid var(--info-dark);
        }

        @keyframes slideInToast {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* üé® COLOR PICKERS */
        .color-picker-group {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .color-picker {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .color-picker label {
            font-size: 0.875rem;
            font-weight: var(--font-medium);
            color: var(--text-primary);
        }

        .color-picker input[type="color"] {
            width: 3rem;
            height: 2.5rem;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            background: none;
        }

        .color-picker input[type="color"]:hover {
            border-color: var(--primary-blue);
            transform: scale(1.05);
        }

        .color-picker input[type="color"]:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* üì± RESPONSIVE UTILITIES */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        @media (max-width: 640px) {
            .hidden-sm {
                display: none !important;
            }

            .container {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .card {
                padding: 1.5rem;
            }

            .grid {
                gap: 1.5rem;
            }
        }

        /* üéØ ACCESIBILIDAD AVANZADA */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        @media (prefers-contrast: more) {
            :root {
                --border-light: var(--border-strong);
                --border-medium: var(--gray-600);
            }

            .card {
                border-width: 2px;
            }

            .btn {
                border-width: 2px;
            }
        }

        /* üó∫Ô∏è MAP STYLES MEJORADOS */
        .map-field-container {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .map-controls {
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 1.5rem;
        }

        .map-controls-title {
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .map-controls-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .leaflet-map {
            height: 400px;
            border: none;
        }

        /* üé® FORM GENERATOR STYLES */
        .generated-form {
            --form-primary: var(--primary-blue);
            --form-danger: var(--danger-dark);
            --form-text: var(--text-primary);
            --form-bg: var(--surface-elevated);
            --form-border: var(--border-medium);
        }

        .form-fields-container {
            margin-bottom: 2rem;
        }

        .form-fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .generated-form .form-group {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 0;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-xs);
        }

        .generated-form .form-group:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .generated-form .form-group:focus-within {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .generated-form label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .generated-form .field-icon {
            color: var(--primary-blue);
            opacity: 0.8;
            font-size: 1rem;
        }

        .generated-form .required-asterisk {
            color: var(--danger-dark);
            font-weight: var(--font-bold);
            margin-left: 0.25rem;
        }

        .generated-form .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: 1rem;
            color: var(--text-primary);
            background-color: var(--surface-elevated);
            transition: all var(--transition-fast);
            font-family: var(--font-sans);
        }

        .generated-form .form-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .generated-form .form-control.invalid {
            border-color: var(--danger-dark);
            background-color: rgba(185, 28, 28, 0.05);
        }

        .generated-form .field-error {
            color: var(--danger-dark);
            font-size: 0.875rem;
            font-weight: var(--font-medium);
            margin-top: 0.5rem;
        }

        .generated-form .field-help-text {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            line-height: var(--leading-normal);
        }

        .switch-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-strong);
            transition: var(--transition-base);
            border-radius: 1.5rem;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            width: 1.125rem;
            left: 0.1875rem;
            bottom: 0.1875rem;
            background-color: white;
            transition: var(--transition-base);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked + .slider {
            background-color: var(--primary-blue);
        }

        input:checked + .slider:before {
            transform: translateX(1.5rem);
        }

        .switch-label {
            font-size: 0.875rem;
            font-weight: var(--font-medium);
            color: var(--text-primary);
        }

        /* Grupos de campos */
        .field-group {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .group-header {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
        }

        .group-header::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-blue), var(--primary-purple));
        }

        .group-header:hover {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
        }

        .group-header h4 {
            margin: 0;
            font-size: 1.125rem;
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .group-icon {
            color: var(--primary-blue);
            font-size: 1rem;
        }

        .group-toggle {
            background-color: var(--surface-elevated);
            border: 1px solid var(--border-medium);
            color: var(--text-primary);
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-xs);
        }

        .group-toggle:hover {
            background-color: var(--primary-blue);
            color: white;
            transform: scale(1.1);
            box-shadow: var(--shadow-sm);
        }

        .group-fields {
            padding: 1.5rem;
            background-color: var(--bg-primary);
        }

        .form-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .generated-form .submit-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .generated-form .submit-btn:hover {
            background-color: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .generated-form .cancel-btn {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-medium);
            padding: 0.75rem 2rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .generated-form .cancel-btn:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-strong);
        }

        .content-type-selector {
            border-color: var(--primary-blue) !important;
            background-color: rgba(59, 130, 246, 0.05) !important;
        }

        .dependent-field {
            border-color: var(--primary-purple) !important;
            background-color: rgba(107, 33, 168, 0.05) !important;
        }

        .dependency-indicator {
            position: absolute;
            left: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-blue);
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(1rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .generated-form .form-group {
            animation: fadeIn 0.3s ease-out;
        }

        .highlight {
            background-color: rgba(251, 191, 36, 0.3);
            padding: 0.125rem 0.25rem;
            border-radius: var(--radius-sm);
            font-weight: var(--font-semibold);
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <a href="#" class="header-logo">
            <div class="logo-icon">
                <i class="fas fa-puzzle-piece"></i>
            </div>
            <div>
                <div class="header-title">FormGenerator</div>
                <div class="header-subtitle">Comprehensive Methodology for Dynamic Forms</div>
            </div>
        </a>
        <div class="header-controls">
            <button class="theme-toggle" id="themeToggle"
                    title="Alternar modo oscuro"
                    aria-label="Alternar entre modo claro y oscuro">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>
</header>

<div class="container">
    <div class="grid grid-cols-1">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <h2 class="card-title">Carregar Objecte Existent</h2>
            </div>

            <div class="grid grid-cols-3">
                <div class="form-group">
                    <label for="editModel" class="form-label">Model:</label>
                    <select id="editModel" class="form-control">
                        <option value="">-- Selecciona model --</option>
                        <option value="cliente">Cliente</option>
                        <option value="clienteempresa">Cliente Empresa</option>
                        <option value="clienteparticular">Cliente Particular</option>
                        <option value="producto">Producto</option>
                        <option value="compra">Compra</option>
                        <option value="comentario">Comentario</option>
                        <option value="categoria">Categoria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editId" class="form-label">ID:</label>
                    <input type="number" id="editId" class="form-control"
                           placeholder="Ex: 1" min="1">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button id="editLoad" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Carregar
                    </button>
                </div>
            </div>

            <div id="loadingIndicator" class="loading hidden">
                <div class="spinner"></div>
                Carregant dades...
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h2 id="formTitle" class="card-title">Crear Objecte Nou</h2>
            </div>

            <div class="form-group">
                <label for="modelSelect" class="form-label">Model:</label>
                <select id="modelSelect" class="form-control">
                    <option value="">-- Selecciona model --</option>
                    <option value="cliente">Cliente</option>
                    <option value="clienteempresa">Cliente Empresa</option>
                    <option value="clienteparticular">Cliente Particular</option>
                    <option value="producto">Producto</option>
                    <option value="categoria">Categoria</option>
                    <option value="compra">Compra</option>
                    <option value="comentario">Comentario</option>
                </select>
            </div>

            <div class="form-group">
                <label for="styleSelect" class="form-label">Estil del formulari:</label>
                <select id="styleSelect" class="form-control">
                    <option value="">Estil per defecte</option>
                    <option value="modern">Modern</option>
                    <option value="classic">Cl√†ssic</option>
                    <option value="corporate">Corporatiu</option>
                    <option value="file">Desde Arxiu</option>
                </select>
            </div>

            <div id="customStyleFile" class="form-group hidden">
                <label for="styleFile" class="form-label">Arxiu CSS personalitzat:</label>
                <div class="grid grid-cols-2">
                    <input type="file" id="styleFile" accept=".css" class="form-control">
                    <button id="loadStyleFileBtn" class="btn btn-secondary">
                        <i class="fas fa-upload"></i>
                        Aplicar
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Colors del tema:</label>
                <div class="color-picker-group">
                    <div class="color-picker">
                        <label for="primaryColor">Color principal:</label>
                        <input type="color" id="primaryColor" value="#1e40af">
                    </div>
                    <div class="color-picker">
                        <label for="errorColor">Color d'error:</label>
                        <input type="color" id="errorColor" value="#b91c1c">
                    </div>
                    <button id="applyColorsBtn" class="btn btn-success">
                        <i class="fas fa-paint-brush"></i>
                        Aplicar Colors
                    </button>
                </div>
            </div>

            <div id="formContainer"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-database"></i>
                </div>
                <h2 class="card-title">Navegador de Dades</h2>
            </div>

            <div class="search-container">
                <input type="text" id="searchData"
                       class="form-control search-input"
                       placeholder="Cerca models, IDs, contingut..."
                       autocomplete="off">
            </div>

            <div class="tabs">
                <button class="tab-btn active" data-model="cliente">
                    <i class="fas fa-address-card"></i>
                    Tots Clients
                </button>
                <button class="tab-btn" data-model="clienteempresa">
                    <i class="fas fa-building"></i>
                    Clients Empresa
                </button>
                <button class="tab-btn" data-model="clienteparticular">
                    <i class="fas fa-user"></i>
                    Clients Particulars
                </button>
                <button class="tab-btn" data-model="producto">
                    <i class="fas fa-box"></i>
                    Productes
                </button>
                <button class="tab-btn" data-model="categoria">
                    <i class="fas fa-tags"></i>
                    Categories
                </button>
                <button class="tab-btn" data-model="compra">
                    <i class="fas fa-receipt"></i>
                    Compres
                </button>
                <button class="tab-btn" data-model="comentario">
                    <i class="fas fa-comment"></i>
                    Comentaris
                </button>
            </div>

            <div id="dataList" class="list-container">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="empty-state-title">Selecciona una pestanya</div>
                    <div class="empty-state-description">
                        Tria un tipus de model per veure les dades disponibles
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast-container"></div>

<script type="module">
    import FormGenerator from './js/formGenerator.js';

    let currentForm = null;
    let currentModel = '';
    let loadedItems = [];

    const $ = selector => document.querySelector(selector);

    function initTheme() {
        const savedTheme = localStorage.getItem('preferredTheme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const defaultTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

        applyTheme(defaultTheme);
    }

    function applyTheme(theme) {
        const html = document.documentElement;
        const themeToggle = $('#themeToggle');

        html.setAttribute('data-theme', theme);

        const icon = themeToggle.querySelector('i');
        icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

        const newTitle = theme === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
        themeToggle.title = newTitle;
        themeToggle.setAttribute('aria-label', newTitle);

        localStorage.setItem('preferredTheme', theme);

    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
        showToast(`Modo ${newTheme === 'dark' ? 'oscuro' : 'claro'} activado`, 'success');
    }

    $('#themeToggle').addEventListener('click', toggleTheme);
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('preferredTheme')) {
            applyTheme(e.matches ? 'dark' : 'light');
        }
    });
    initTheme();

    /**
     * Obtiene el tema preferido del usuario
     * @returns {string} El tema preferido ('light' o 'dark')
     */
    function getPreferredTheme() {
        const savedTheme = localStorage.getItem('formGeneratorTheme');
        if (savedTheme) {
            return savedTheme;
        }

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
        }

        return 'light';
    }

    /**
     * Muestra un toast de notificaci√≥n
     * @param {string} message - Mensaje a mostrar
     * @param {string} type - Tipo de notificaci√≥n (success, error)
     * @param {string} title - T√≠tulo opcional
     */
    function showToast(message, type = 'success', title = '') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        let iconClass = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        let titleText = title || (type === 'success' ? 'Operaci√≥ correcta' : 'Error');

        toast.innerHTML = `
        <i class="${iconClass}"></i>
        <div class="toast-content">
          <div class="toast-title">${titleText}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">&times;</button>
      `;

        $('#toast-container').appendChild(toast);

        toast.querySelector('.toast-close').addEventListener('click', () => {
            toast.remove();
        });

        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    /**
     * Muestra/oculta el indicador de carga
     * @param {boolean} show - Si debe mostrarse
     */
    function toggleLoading(show) {
        $('#loadingIndicator').classList.toggle('hidden', !show);
    }

    async function loadForm(model, editMode = false, id = null, initialData = null) {
        try {
            if (!model) {
                return;
            }

            if (editMode && !id) {
                console.error('‚ùå loadForm: ID requerido para modo edici√≥n');
                showToast('Error: ID requerido per editar', 'error');
                return;
            }


            currentModel = model;
            const API_BASE_URL = 'http://localhost:8000';

            if (editMode && id && !initialData) {
                initialData = await apiRequest(`${API_BASE_URL}/api/get/${model}/${id}/`);
            }

            const schema = await apiRequest(`${API_BASE_URL}/api/schema/${model}/`);

            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';

            currentForm = new FormGenerator({
                schema,
                model,
                container: $('#formContainer'),
                initialData,
                editMode,
                editId: id,
                theme: currentTheme,

                apiConfig: {
                    baseUrl: API_BASE_URL,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                },

                options: {
                    showThemeToggle: false,
                    debug: true
                },

                onSubmitSuccess: (result) => {
                    showToast(
                        editMode
                            ? `${model.charAt(0).toUpperCase() + model.slice(1)} actualitzat correctament`
                            : `${model.charAt(0).toUpperCase() + model.slice(1)} creat correctament`
                    );

                    updateFormTitle(model, editMode, id);

                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab && activeTab.dataset.model === model) {
                        activeTab.click();
                    }

                    if (!editMode) {
                        currentForm.resetForm();
                    }
                },

                onSubmitError: (error) => {
                    console.error('Error detallado:', error);
                    showToast(error.message || 'Error al enviar el formulario', 'error');
                },

                onCancel: () => {
                    $('#modelSelect').value = '';
                    $('#formContainer').innerHTML = '';
                    updateFormTitle('', false);
                }
            });

            currentForm.renderForm();
            updateFormTitle(model, editMode, id);
            setupPolymorphicFields();

            setTimeout(() => {
                if (currentForm) {
                    const newTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    currentForm.setTheme(newTheme);
                }

                const mapContainers = document.querySelectorAll('.map-field-container');
                mapContainers.forEach(container => {
                    const mapElement = container.querySelector('.leaflet-map');
                    if (mapElement && mapElement.id) {
                        const mapId = mapElement.id;
                        if (window.mapInstances && window.mapInstances[mapId]) {
                            window.mapInstances[mapId].invalidateSize();
                        }
                    }
                });
            }, 500);

            if (schema.isPolymorphic) {
                if (editMode && initialData) {
                    const contentTypeField = document.getElementById(schema.contentTypeField);
                    const objectIdField = document.getElementById(schema.objectIdField);

                    if (contentTypeField && objectIdField && initialData[schema.contentTypeField]) {
                        try {
                            const objectsData = await apiRequest(
                                `${API_BASE_URL}/api/content-type-objects/${initialData[schema.contentTypeField]}/`
                            );

                            objectIdField.innerHTML = '<option value="">-- Seleccionar --</option>';

                            objectsData.forEach(obj => {
                                const option = document.createElement('option');
                                option.value = obj.id;
                                option.textContent = obj.text;
                                objectIdField.appendChild(option);
                            });

                            objectIdField.value = initialData[schema.objectIdField] || '';
                        } catch (error) {
                            console.error('Error al cargar opciones relacionadas:', error);
                        }
                    }
                }
            }

        } catch (error) {
            console.error('Error al cargar el formulario:', error);
            showToast('Error al cargar el formulario: ' + error.message, 'error');
        }
    }

    async function apiRequest(url, options = {}) {
        try {
            if (url.includes('undefined')) {
                console.error('‚ùå URL contiene undefined:', url);
                throw new Error('URL mal formada: contiene undefined');
            }

            toggleLoading(true);


            const response = await fetch(url, options);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Error en la petici√≥');
            }
            return data;
        } catch (error) {
            console.error('‚ùå Error en apiRequest:', error);
            showToast(error.message, 'error');
            throw error;
        } finally {
            toggleLoading(false);
        }
    }

    /**
     * Actualiza el t√≠tulo del formulario seg√∫n el modo
     */
    function updateFormTitle(model, editMode, id = null) {
        const title = $('#formTitle');
        if (!model) {
            title.innerHTML = '<i class="fas fa-clipboard-list"></i> Crear objecte nou';
            return;
        }

        const modelName = model.charAt(0).toUpperCase() + model.slice(1);

        if (editMode) {
            title.innerHTML = `<i class="fas fa-edit"></i> Editar ${modelName} <span class="badge badge-primary">ID: ${id}</span>`;
        } else {
            title.innerHTML = `<i class="fas fa-plus-circle"></i> Crear ${modelName} nou`;
        }
    }

    /**
     * Renderiza la lista de elementos
     */
    function renderItemsList(model, items) {
        const dataList = $('#dataList');

        if (!items || items.length === 0) {
            dataList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>No hi ha ${model}s per mostrar</p>
          </div>
        `;
            return;
        }


        loadedItems = items;

        dataList.innerHTML = `
        <div class="list-header">
          <h3>
            <i class="fas fa-list"></i> ${model.charAt(0).toUpperCase() + model.slice(1)}s
            <span class="badge badge-primary">${items.length}</span>
          </h3>
        </div>
      `;

        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.dataset.id = item.id;

            const summary = Object.entries(item)
                .filter(([k, _]) => k !== 'id')
                .map(([k, v]) => `<strong>${k}:</strong> ${v}`)
                .join(' | ');

            div.innerHTML = `
          <div class="list-content">
            <strong>#${item.id}</strong> - ${summary}
          </div>
          <div class="actions">
            <button class="btn btn-sm editBtn" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger deleteBtn" title="Eliminar">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;

            dataList.appendChild(div);

            div.querySelector('.editBtn').addEventListener('click', async () => {
                try {
                    const obj = await apiRequest(`http://localhost:8000/api/get/${model}/${item.id}/`);
                    loadForm(model, true, item.id, obj);

                    $('#modelSelect').value = model;

                    $('#formTitle').scrollIntoView({behavior: 'smooth'});
                } catch (error) {
                    console.error('Error al cargar el elemento:', error);
                }
            });

            div.querySelector('.deleteBtn').addEventListener('click', async () => {
                try {
                    if (!confirm(`Segur que vols eliminar ${model} amb ID ${item.id}?`)) return;

                    const result = await apiRequest(
                        `http://localhost:8000/api/delete/${model}/${item.id}/`,
                        {method: 'DELETE'}
                    );

                    showToast(result.message);

                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        activeTab.click();
                    }
                } catch (error) {
                    console.error('Error al eliminar:', error);
                }
            });
        });
    }

    /**
     * Filtra los elementos de la lista seg√∫n el t√©rmino de b√∫squeda
     */
    function filterItems(searchTerm) {
        if (!loadedItems.length) return;

        const dataList = $('#dataList');
        const items = dataList.querySelectorAll('.list-item');

        if (!searchTerm) {
            items.forEach(item => item.classList.remove('hidden'));
            return;
        }

        const term = searchTerm.toLowerCase();

        items.forEach(item => {
            const id = item.dataset.id;
            const currentItem = loadedItems.find(i => i.id.toString() === id);

            if (!currentItem) return;

            const itemText = JSON.stringify(currentItem).toLowerCase();
            const match = itemText.includes(term);

            item.classList.toggle('hidden', !match);

            if (match) {
                const content = item.querySelector('.list-content');
                let htmlContent = content.innerHTML;

                htmlContent = htmlContent.replace(/<span class="highlight">(.+?)<\/span>/g, '$1');

                const regex = new RegExp(term, 'gi');
                htmlContent = htmlContent.replace(regex, match => `<span class="highlight">${match}</span>`);

                content.innerHTML = htmlContent;
            }
        });

        const visibleItems = Array.from(items).filter(item => !item.classList.contains('hidden'));

        if (visibleItems.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
          <i class="fas fa-search"></i>
          <p>No s'han trobat resultats per "${searchTerm}"</p>
        `;

            const existingEmpty = dataList.querySelector('.empty-state');
            if (existingEmpty) {
                existingEmpty.remove();
            }

            dataList.appendChild(emptyState);
        } else {
            const existingEmpty = dataList.querySelector('.empty-state');
            if (existingEmpty) {
                existingEmpty.remove();
            }
        }
    }

    function syncFormTheme() {
        if (currentForm) {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            currentForm.setTheme(currentTheme);
        }
    }

    $('#themeToggle').addEventListener('click', () => {
        setTimeout(syncFormTheme, 100);
    });

    $('#modelSelect').addEventListener('change', function () {
        $('#styleSelect').value = '';
        loadForm(this.value);
        if (this.value === 'comentario') {
            setTimeout(setupPolymorphicFields, 300);
        }
    });

    $('#editLoad').addEventListener('click', async () => {
        const model = $('#editModel').value.trim().toLowerCase();
        const id = $('#editId').value;

        if (!model || !id) {
            return showToast('Has d\'indicar model i ID', 'error');
        }

        if (isNaN(id) || parseInt(id) <= 0) {
            return showToast('L\'ID ha de ser un n√∫mero v√†lid', 'error');
        }

        try {

            const data = await apiRequest(`http://localhost:8000/api/get/${model}/${id}/`);

            if (!data) {
                throw new Error('Objecte no trobat');
            }
            await loadForm(model, true, parseInt(id), data);
            $('#modelSelect').value = model;
            updateFormTitle(model, true, id);

            $('#formTitle').scrollIntoView({behavior: 'smooth'});

            showToast(`Objecte ${model} #${id} carregat correctament`, 'success');

        } catch (error) {
            console.error('Error al cargar el elemento:', error);
            showToast(`Error al carregar: ${error.message}`, 'error');
        }
    });

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('active');
            });
            btn.classList.add('active');

            const model = btn.dataset.model;

            try {
                $('#dataList').innerHTML = '<div class="loader"></div>';

                const data = await apiRequest(`http://localhost:8000/api/${model}/`);
                renderItemsList(model, data);
            } catch (error) {
                console.error('Error al cargar datos:', error);
                $('#dataList').innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>Error al cargar les dades: ${error.message}</p>
            </div>
          `;
            }
        });
    });

    $('#searchData').addEventListener('input', function () {
        filterItems(this.value);
    });

    document.querySelector('.tab-btn').click();

    function setupPolymorphicFields() {
        if (currentModel === 'comentario' && currentForm) {
            const contentTypeSelect = document.getElementById('content_type');
            const objectIdSelect = document.getElementById('object_id');

            if (contentTypeSelect && objectIdSelect) {
                contentTypeSelect.removeEventListener('change', handleContentTypeChange);
                contentTypeSelect.addEventListener('change', handleContentTypeChange);

                if (contentTypeSelect.value) {
                    handleContentTypeChange.call(contentTypeSelect);
                }
            }
        }
    }

    async function handleContentTypeChange() {
        const contentTypeId = this.value;
        const objectIdSelect = document.getElementById('object_id');

        if (!objectIdSelect) return;


        if (!contentTypeId) {
            objectIdSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            return;
        }

        objectIdSelect.disabled = true;
        objectIdSelect.innerHTML = '<option value="">Cargando...</option>';

        try {
            const response = await fetch(`http://localhost:8000/api/content-type-objects/${contentTypeId}/`);

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const objects = await response.json();
            objectIdSelect.innerHTML = '<option value="">-- Seleccionar --</option>';

            objects.forEach(obj => {
                const option = document.createElement('option');
                option.value = obj.id;
                option.textContent = obj.text;
                objectIdSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando objetos:', error);
            objectIdSelect.innerHTML = '<option value="">Error al cargar opciones</option>';
        } finally {
            objectIdSelect.disabled = false;
        }
    }

    $('#styleSelect').addEventListener('change', function () {
        if (!currentForm) {
            showToast('Primero selecciona un modelo', 'error');
            this.value = '';
            return;
        }

        const selectedStyle = this.value;

        $('#customStyleFile').classList.toggle('hidden', selectedStyle !== 'file');

        if (selectedStyle && selectedStyle !== 'file') {
            applyPredefinedStyle(selectedStyle);
        }
    });

    $('#loadStyleFileBtn').addEventListener('click', function () {
        if (!currentForm) {
            showToast('Primero selecciona un modelo', 'error');
            return;
        }

        const fileInput = $('#styleFile');
        const file = fileInput.files[0];

        if (!file) {
            showToast('Por favor, selecciona un archivo CSS', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const cssContent = e.target.result;
            currentForm.applyCustomStyles(cssContent);
            showToast('Estilos aplicados correctamente', 'success');
        };

        reader.onerror = function () {
            showToast('Error al leer el archivo', 'error');
        };

        reader.readAsText(file);
    });

    $('#applyColorsBtn').addEventListener('click', function () {
        if (!currentForm) {
            showToast('Primero selecciona un modelo', 'error');
            return;
        }

        const primaryColor = $('#primaryColor').value;
        const errorColor = $('#errorColor').value;

        const generatedForm = document.querySelector('.generated-form');
        if (generatedForm) {
            generatedForm.style.setProperty('--primary-color', primaryColor);
            generatedForm.style.setProperty('--error-color', errorColor);
            const primaryDark = darkenColor(primaryColor, 10);
            generatedForm.style.setProperty('--primary-dark', primaryDark);
        }

        currentForm.applyCustomTheme({
            primaryColor: primaryColor,
            errorColor: errorColor
        });

        applyColorsToElements(primaryColor, errorColor);

        showToast('Colores aplicados correctamente', 'success');
    });

    function darkenColor(color, percent) {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) - amt;
        const G = (num >> 8 & 0x00FF) - amt;
        const B = (num & 0x0000FF) - amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    function applyColorsToElements(primaryColor, errorColor) {
        const fieldIcons = document.querySelectorAll('.generated-form .field-icon');
        fieldIcons.forEach(icon => {
            icon.style.color = primaryColor;
        });

        const submitBtn = document.querySelector('.generated-form .submit-btn');
        if (submitBtn) {
            submitBtn.style.backgroundColor = primaryColor;
            submitBtn.style.borderColor = primaryColor;
        }

        const inputs = document.querySelectorAll('.generated-form input, .generated-form select, .generated-form textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function () {
                this.style.borderColor = primaryColor;
                this.style.boxShadow = `0 0 0 3px ${primaryColor}30`;
            });
        });

        const asterisks = document.querySelectorAll('.generated-form .required-asterisk');
        asterisks.forEach(asterisk => {
            asterisk.style.color = errorColor;
        });

        const errorDivs = document.querySelectorAll('.generated-form .field-error');
        errorDivs.forEach(errorDiv => {
            errorDiv.style.color = errorColor;
        });

    }

    function applyPredefinedStyle(styleName) {
        if (!currentForm) return;

        const styles = {
            modern: {
                '.form-group': {
                    padding: '16px',
                    borderRadius: '12px',
                    backgroundColor: 'rgba(245, 247, 250, 0.6)',
                    marginBottom: '20px',
                    boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)',
                    transition: 'all 0.3s ease'
                },
                'input, select, textarea': {
                    padding: '14px',
                    borderRadius: '8px',
                    border: '1px solid #e1e8ed',
                    fontSize: '15px',
                    transition: 'all 0.2s ease'
                },
                'input:focus, select:focus, textarea:focus': {
                    boxShadow: '0 0 0 3px rgba(29, 161, 242, 0.2)',
                    borderColor: '#1da1f2'
                },
                'label': {
                    fontWeight: '600',
                    marginBottom: '10px',
                    fontSize: '14px',
                    color: '#14171a'
                },
                '.submit-btn': {
                    backgroundColor: '#1da1f2',
                    padding: '12px 24px',
                    borderRadius: '30px',
                    fontWeight: '700',
                    textTransform: 'uppercase',
                    fontSize: '14px',
                    letterSpacing: '0.5px'
                },
                '.cancel-btn': {
                    backgroundColor: '#f5f8fa',
                    color: '#657786',
                    padding: '12px 24px',
                    borderRadius: '30px',
                    fontWeight: '700',
                    textTransform: 'uppercase',
                    fontSize: '14px',
                    letterSpacing: '0.5px'
                }
            },
            classic: {
                '.form-group': {
                    padding: '16px',
                    borderRadius: '0',
                    borderLeft: '4px solid #4361ee',
                    marginBottom: '20px',
                    backgroundColor: '#fff',
                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)'
                },
                'input, select, textarea': {
                    padding: '10px',
                    borderRadius: '0',
                    borderWidth: '0 0 2px 0',
                    borderColor: '#ddd',
                    fontSize: '16px'
                },
                'input:focus, select:focus, textarea:focus': {
                    borderColor: '#4361ee',
                    boxShadow: 'none'
                },
                'label': {
                    fontWeight: '500',
                    marginBottom: '8px',
                    color: '#333'
                },
                '.submit-btn': {
                    backgroundColor: '#4361ee',
                    borderRadius: '0',
                    padding: '10px 20px',
                    fontWeight: '600'
                },
                '.cancel-btn': {
                    backgroundColor: '#f8f9fa',
                    borderRadius: '0',
                    color: '#333',
                    padding: '10px 20px',
                    borderWidth: '1px',
                    borderColor: '#ddd'
                }
            },
            corporate: {
                '.form-group': {
                    padding: '20px',
                    borderRadius: '5px',
                    borderTop: '4px solid #2c3e50',
                    marginBottom: '24px',
                    backgroundColor: '#fff',
                    boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
                },
                'input, select, textarea': {
                    padding: '12px',
                    borderRadius: '4px',
                    border: '1px solid #bdc3c7',
                    fontSize: '15px'
                },
                'input:focus, select:focus, textarea:focus': {
                    borderColor: '#3498db',
                    boxShadow: '0 0 0 3px rgba(52, 152, 219, 0.2)'
                },
                'label': {
                    fontWeight: '600',
                    marginBottom: '8px',
                    color: '#2c3e50',
                    fontSize: '14px'
                },
                '.submit-btn': {
                    backgroundColor: '#2c3e50',
                    padding: '12px 24px',
                    borderRadius: '4px',
                    fontWeight: '600'
                },
                '.cancel-btn': {
                    backgroundColor: '#ecf0f1',
                    color: '#34495e',
                    padding: '12px 24px',
                    borderRadius: '4px',
                    fontWeight: '600',
                    border: 'none'
                }
            }
        };

        if (styles[styleName]) {
            currentForm.applyCustomStyles(styles[styleName]);
            showToast(`Estilo "${styleName}" aplicado correctamente`, 'success');
        } else {
            showToast('Estilo no encontrado', 'error');
        }
    }
</script>
</body>
</html>